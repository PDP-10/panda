(FILECREATED "23-OCT-83 23:23:31" <LISPUSERS>DFOR10.DATATYPE;1 3244   )


(* Copyright (c) 1983 by Xerox Corporation)

(PRETTYCOMPRINT DFOR10COMS)

(RPAQQ DFOR10COMS [(FNS GETSTREAM BIN BOUT OPENSTREAM STREAMP)
		   (RECORDS STREAM)
		   (PROP 10MACRO \BIN \BOUT KNOWNSMALLP BIN2 BOUT2 \BIN2 \BOUT2)
		   [VARS (FILESTREAMS (LIST (HARRAY 10]
		   (DECLARE: EVAL@COMPILE DONTCOPY (P (FILESLOAD (FROM LISPUSERS)
								 CJSYS])
(DEFINEQ

(GETSTREAM
  [LAMBDA (FILE ACCESS)            (* lmm "23-OCT-83 23:18")
    (OR ACCESS (SETQ ACCESS (QUOTE INPUT)))
    (PROG NIL
          (COND
	    ((STREAMP FILE)
	      (RETURN FILE)))
          (RETURN (COND
		    [(CDR (ASSOC ACCESS (OR (GETHASH FILE FILESTREAMS)
					    (GETHASH (SETQ FILE (OPENP (OR FILE
									   (SELECTQ ACCESS
										    (OUTPUT (OUTPUT))
										    (INPUT)))
								       ACCESS))
						     FILESTREAMS]
		    (T (PROG [(STR (create STREAM
					   FULLNAME _ FILE
					   JFN _(OPNJFN FILE ACCESS]
			     [AND (NEQ FILE T)
				  (WHENCLOSE FILE (QUOTE BEFORE)
					     (FUNCTION (LAMBDA (X)
						 (PUTHASH X NIL FILESTREAMS]
			     (PUTHASH FILE (CONS (CONS ACCESS STR)
						 (GETHASH FILE FILESTREAMS))
				      FILESTREAMS)
			     (RETURN STR])

(BIN
  [LAMBDA (FILE)                   (* lmm "23-OCT-83 23:09")
    (\BIN (if (type? STREAM FILE)
	      then FILE
	    else (GETSTREAM FILE (QUOTE INPUT])

(BOUT
  [LAMBDA (STREAM BYTE)            (* lmm "23-OCT-83 23:10")
    (\BOUT (if (type? STREAM FILE)
	       then FILE
	     else (GETSTREAM STREAM (QUOTE OUTPUT)))
	   BYTE])

(OPENSTREAM
  [LAMBDA (FILE ACCESS RECOG BYTESIZE MACHINE.DEPENDENT.PARAMETERS)
                                   (* lmm "23-OCT-83 23:11")
    (GETSTREAM (OPENFILE FILE ACCESS RECOG BYTESIZE MACHINE.DEPENDENT.PARAMETERS)
	       ACCESS])

(STREAMP
  [LAMBDA (STR)                    (* lmm "23-OCT-83 22:53")
    (type? STREAM STR])
)
[DECLARE: EVAL@COMPILE 

(DATATYPE STREAM ((FULLNAME POINTER)
		  (JFN BITS 18)))
]
[/DECLAREDATATYPE (QUOTE STREAM)
		  (QUOTE (POINTER (BITS 18]

(PUTPROPS \BIN 10MACRO ((X)
			(JS BIN (ffetch JFN of X)
			    NIL NIL 2)))

(PUTPROPS \BOUT 10MACRO ((STREAM BYTE)
			 (JS BOUT (ffetch JFN of STREAM)
			     (KNOWNSMALLP BYTE)
			     NIL 2)))

(PUTPROPS KNOWNSMALLP 10MACRO ((X)
			       X))

(PUTPROPS BIN2 10MACRO (OPENLAMBDA (STREAM)
				   (LOGOR (LLSH (BIN STREAM)
						8)
					  (BIN STREAM))))

(PUTPROPS BOUT2 10MACRO (OPENLAMBDA (STREAM WORD)
				    (BOUT STREAM (LRSH WORD 8))
				    (BOUT STREAM (LOGAND WORD 255))))

(PUTPROPS \BIN2 10MACRO (OPENLAMBDA (STREAM)
				    (LOGOR (LLSH (\BIN STREAM)
						 8)
					   (\BIN STREAM))))

(PUTPROPS \BOUT2 10MACRO (OPENLAMBDA (STREAM WORD)
				     (\BOUT STREAM (LRSH WORD 8))
				     (\BOUT STREAM (LOGAND WORD 255))))

(RPAQ FILESTREAMS (LIST (HARRAY 10)))
(DECLARE: EVAL@COMPILE DONTCOPY 
(FILESLOAD (FROM LISPUSERS)
	   CJSYS)
)
(PUTPROPS DFOR10.DATATYPE COPYRIGHT ("Xerox Corporation" 1983))
(DECLARE: DONTCOPY
  (FILEMAP (NIL (450 2079 (GETSTREAM 462 . 1300) (BIN 1304 . 1493) (BOUT 1497 . 1706) (OPENSTREAM 1710 .
 1965) (STREAMP 1969 . 2076)))))
STOP
